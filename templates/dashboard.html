<!DOCTYPE html>
<html>
<head>
<title>Driver Safety Dashboard</title>
<style>
body { font-family: Arial; background:#121212; color:white; text-align:center; }
.card { background:#1f1f1f; padding:20px; margin:20px auto; width:400px; border-radius:10px; }
button { padding:10px 20px; border:none; border-radius:6px; background:#00c853; color:white; cursor:pointer; }
video { border-radius:10px; margin-top:20px; }
.safe { color:#00ff88; }
.alert { color:#ff4c4c; font-weight:bold; }
a { color:#00ff88; text-decoration:none; }
input { padding:8px; margin:5px; width:90%; border-radius:6px; border:none; }
</style>
</head>
<body>

<h1>ðŸš— Driver Safety Dashboard</h1>

<div class="card">
<h3>Enter Driving Details</h3>
<input type="text" id="occupation" placeholder="Occupation">
<input type="text" id="route" placeholder="Route">
<br><br>
<button onclick="startSession()">Start Monitoring</button>
</div>

<video id="video" width="400" autoplay></video>

<div class="card">
<h2>Status</h2>
<div id="statusText">Waiting...</div>
<div id="predictiveText"></div>
</div>

<div class="card">
<h2>Live Analytics</h2>
<p>Total Checks: <span id="totalChecks">0</span></p>
<p>Drowsy Events: <span id="alertCount">0</span></p>
<p>Safety Score: <span id="safetyScore">100</span>%</p>
</div>

<div class="card">
<a href="/generate-full-demo-data">Generate Demo Data</a><br><br>
<a href="/analytics">View Analytics</a>
</div>

<script>
const video = document.getElementById("video");
const statusText = document.getElementById("statusText");
const predictiveText = document.getElementById("predictiveText");
const alertCount = document.getElementById("alertCount");
const totalChecks = document.getElementById("totalChecks");
const safetyScore = document.getElementById("safetyScore");

let monitoring = false;

// Camera
navigator.mediaDevices.getUserMedia({ video: true })
.then(stream => video.srcObject = stream)
.catch(err => alert("Camera access denied"));

async function startSession() {

    const occupation = document.getElementById("occupation").value;
    const route = document.getElementById("route").value;

    const res = await fetch("/start-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ occupation: occupation, route: route })
    });

    const data = await res.json();

    if (data.predictive_risk === "HIGH") {
        predictiveText.innerHTML = "âš  HIGH PREDICTIVE RISK";
        predictiveText.className = "alert";
    } else {
        predictiveText.innerHTML = "Predictive Risk: LOW";
        predictiveText.className = "safe";
    }

    monitoring = true;
    processFrame();
}

async function processFrame() {
    if (!monitoring) return;

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);

    const image = canvas.toDataURL("image/jpeg");

    const analyzeRes = await fetch("/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: image })
    });

    const analyzeData = await analyzeRes.json();

    if (analyzeData.status === "SAFE") {
        statusText.innerText = "SAFE";
        statusText.className = "safe";
    } else {
        statusText.innerText = "DROWSY ALERT!";
        statusText.className = "alert";
    }

    const summaryRes = await fetch("/summary");
    const summaryData = await summaryRes.json();

    totalChecks.innerText = summaryData.total_checks;
    alertCount.innerText = summaryData.drowsy_events;
    safetyScore.innerText = summaryData.safety_score;

    setTimeout(processFrame, 300);
}
</script>

</body>
</html>